# Makefile for building the kata file with Cucumber
#
# SYNOPSIS:
#
#   make         - makes the gilded rose lib.
#   make featues - makes the targets and runs the features.
#   make clean   - removes all files generated by make.

CC ?= gcc
CFLAGS = -std=c99 -Wall -Wextra -Ideps -fprofile-arcs -ftest-coverage
DEPS = $(wildcard deps/*/*.c)
STEP_DEFINITIONS = $(wildcard features/*/*.c)

CSTEPS_INCLUDE_PATH = $(shell bundle exec csteps-include-path)

LIB = libgilded.so

gilded_rose: gilded_rose.c $(DEPS)
	$(CC) $(CFLAGS) $^ -shared -o $(LIB)

step_definitions: gilded_rose.c $(DEPS) $(STEP_DEFINITIONS)
	$(CC) $(CFLAGS) -I. -I$(CSTEPS_INCLUDE_PATH) $^ -fPIC -shared -o $(LIB)

features: step_definitions
	cucumber

clean:
	rm -f $(LIB)

install-deps:
	clib install stephenmathieson/assertion-macros.h

coverage:
	gcov -abf gilded_rose.c
	lcov --capture --directory . --output-file coverage.info
	genhtml coverage.info --output-directory cov

.PHONY: gilded_rose
